import $ from"jquery";import{featDict}from"@site/static/script/featsIndex";import{featTree}from"@site/static/script/featsIndex";import{getUrlAttributes}from"@site/static/script/common";function connect(e,t,n){let l="";for(let r in e){let a=e[r];l+=(n[a]??a)+t}return l.substring(0,l.length-t.length)}function getTranslatedSource(e){let t="";for(let n in e.source){let l=e.source[n].split(" pg.")[0];t+=(translations.sourceTranslations[l]??l)+", "}return t.substring(0,t.length-2)}function getSimpTranslatedSource(e){if(1==e.source.length)return getTranslatedSource(e);for(let t in e.source){let n=translations.sourceTranslations[e.source[t].split(" pg.")[0]];if(!n.includes("-"))return n+", ..."}for(let t in e.source){let n=translations.sourceTranslations[e.source[t].split(" pg.")[0]];if(n.includes("PCS")||n.includes("PPC"))return n+", ..."}for(let t in e.source){return translations.sourceTranslations[e.source[t].split(" pg.")[0]]+" ..."}return""}function markTree(e,t,n){let l=!1;for(let r in t){let a=t[r];n&&(a.marked=!0,markTree(e,a.children,!0)),a.key==e?(a.marked=!0,a.force=!0,markTree(e,a.children,!0),l=!0):markTree(e,a.children,!1)&&(a.marked=!0,a.force=!0,l=!0)}return l}function printTree(e,t,n){let l="";for(let r in e){let a=e[r];if(a.marked){let e=getTitle(featDict[a.key],!1);a.key!=t?l+=n+'<a style="color:gray" href="/pathfinder/feat?feat='+a.key+'">'+e+"</a>":l+=n+"<a>"+e+"</a>",l+="<br>"+printTree(a.children,t,n+"&#12288;")}}return l}function buildFeatTree(e){let t=JSON.parse(JSON.stringify(featTree));return markTree(e,t),printTree(t,e,"")}function getTitle(e,t=!0){let n=t?'<a href="'+e.url+'">'+e.name+"</a>":e.name,l=null!=e.name_zh?e.name_zh+" ("+n+")":n;return null!=e.race_zh&&(l+=" ["+e.race_zh+"]"),l+=" <sup>"+getTranslatedSource(e)+"</sup>",l}function loadFeat(e,t,n=!1){let l={};for(let o in featDict){let e=getTranslatedSource(featDict[o]).split(", ");for(let t in e)l[e[t].split("-")[0]]=""}t.innerHTML="",n&&(window.top.document.title=e.name_zh??e.name);let r=getTitle(e),a=e.descriptors;null!=a&&(r+="\u3014"+connect(a,", ",translations.featDescriptorsTranslations)+"\u3015"),$(t).append($("<h3>"+r+"</h3>")),null!=e.text_zh?$(t).append($("<p>"+e.text_zh+"</p>")):null!=e.text&&$(t).append($("<p>"+e.text+"</p>")),null!=e.prerequisites_zh?$(t).append($("<p><b>\u5148\u51b3\u6761\u4ef6: </b>"+e.prerequisites_zh+"</p>")):null!=e.prerequisites&&$(t).append($("<p><b>\u5148\u51b3\u6761\u4ef6: </b>"+e.prerequisites+"</p>")),null!=e.benefit_zh?$(t).append($("<p><b>\u4e13\u957f\u6548\u679c: </b>"+e.benefit_zh+"</p>")):null!=e.benefit&&$(t).append($("<p><b>\u4e13\u957f\u6548\u679c: </b>"+e.benefit+"</p>")),null!=e.normal_zh?$(t).append($("<p><b>\u901a\u5e38\u72b6\u51b5: </b>"+e.normal_zh+"</p>")):null!=e.normal&&$(t).append($("<p><b>\u901a\u5e38\u72b6\u51b5: </b>"+e.normal+"</p>")),null!=e.special_zh?$(t).append($("<p><b>\u7279\u6b8a\u8bf4\u660e: </b>"+e.special_zh+"</p>")):null!=e.special&&$(t).append($("<p><b>\u7279\u6b8a\u8bf4\u660e: </b>"+e.special+"</p>")),null!=e.goal_zh?$(t).append($("<p><b>\u4e13\u957f\u76ee\u6807: </b>"+e.goal_zh+"</p>")):null!=e.goal&&$(t).append($("<p><b>\u4e13\u957f\u76ee\u6807: </b>"+e.goal+"</p>")),null!=e.completionBenefit_zh?$(t).append($("<p><b>\u5b8c\u6210\u6536\u76ca: </b>"+e.completionBenefit_zh+"</p>")):null!=e.completionBenefit&&$(t).append($("<p><b>\u5b8c\u6210\u6536\u76ca: </b>"+e.completionBenefit+"</p>"));let i="";for(let o in e.source)i+="<br>"+e.source[o];$(t).append($("<p><b>\u51fa\u5904</b>"+i+"</p>")),null==e.staminaText_zh&&null==e.staminaText||($(t).append($("<hr><h4>\u6218\u7b56</h4></div>")),null!=e.staminaText_zh?$(t).append($("<p>"+e.staminaText_zh+"</p>")):null!=e.staminaText&&$(t).append($("<p>"+e.staminaText+"</p>")),$(t).append($("<p><b>\u51fa\u5904</b><br>"+e.staminaSource+"</p>"))),null==e.mythicBenefit_zh&&null==e.mythicBenefit||($(t).append($("<hr><h4>\u795e\u8bdd\u7248\u672c</h4>")),null!=e.mythicText_zh?$(t).append($("<p>"+e.mythicText_zh+"</p>")):null!=e.mythicText&&$(t).append($("<p>"+e.mythicText+"</p>")),null!=e.mythicPrerequisites_zh?$(t).append($("<p><b>\u5148\u51b3\u6761\u4ef6: </b>"+e.mythicPrerequisites_zh+"</p>")):null!=e.mythicPrerequisites&&$(t).append($("<p><b>\u5148\u51b3\u6761\u4ef6: </b>"+e.mythicPrerequisites+"</p>")),null!=e.mythicBenefit_zh?$(t).append($("<p><b>\u4e13\u957f\u6548\u679c: </b>"+e.mythicBenefit_zh+"</p>")):null!=e.mythicBenefit&&$(t).append($("<p><b>\u4e13\u957f\u6548\u679c: </b>"+e.mythicBenefit+"</p>")),null!=e.mythicNormal_zh?$(t).append($("<p><b>\u901a\u5e38\u72b6\u51b5: </b>"+e.mythicNormal_zh+"</p>")):null!=e.mythicNormal&&$(t).append($("<p><b>\u901a\u5e38\u72b6\u51b5: </b>"+e.mythicNormal+"</p>")),null!=e.mythicSpecial_zh?$(t).append($("<p><b>\u7279\u6b8a\u8bf4\u660e\uff1a</b>"+e.mythicSpecial_zh+"</p>")):null!=e.mythicSpecial&&$(t).append($("<p><b>\u7279\u6b8a\u8bf4\u660e\uff1a</b>"+e.mythicSpecial+"</p>")),$(t).append($("<p><b>\u51fa\u5904</b><br>"+e.mythicSource+"</p>"))),$(t).append($("<hr>")),$(t).append($("<p><b>\u4e13\u957f\u6811</b><br></p>")),$(t).append($("<p>"+buildFeatTree(e.key)+"</p>"))}function loadUrlFeat(){let e=getUrlAttributes().feat;e=e.toLowerCase(),fetch("/pathfinder/feats/"+e+".json").then((e=>e.ok?e.text():null)).then((e=>{if(null!=e){loadFeat(JSON.parse(e),document.getElementById("box"),!0)}})).catch((e=>{console.log(e)}))}function addBoxes(e,t,n,l=!1,r=!0,a=!0,i=null){t.innerHTML="";let o=document.createElement("div");o.style="display: flex; ";let p=document.createElement("input");p.type="checkbox",p.name="all",p.checked=r,o.appendChild(p),n.push(p);let c,s,d=document.createElement("div");if(d.innerHTML="\u5168\u9009",o.appendChild(d),t.appendChild(o),p.addEventListener("change",(e=>{for(let t in n)n[t].checked=e.currentTarget.checked})),!l){let e=document.createElement("div");e.style="display: flex; ";let l=document.createElement("input");l.type="checkbox",l.name="none",l.checked=r,e.appendChild(l),n.push(l);let a=document.createElement("div");a.innerHTML="\u65e0",e.appendChild(a),t.appendChild(e)}a?(c=Object.keys(e),c.sort()):c=e;for(let u in c){let l=document.createElement("div");l.style="display: flex; ";let i=document.createElement("input");i.type="checkbox",i.name=c[u],i.checked=r,l.appendChild(i),n.push(i);let o=document.createElement("div");o.innerHTML=a?e[c[u]]:c[u],l.appendChild(o),t.appendChild(l)}a?(s=Object.keys(i),s.sort()):s=i;for(let u in s){let e=document.createElement("div");e.style="display: flex; ";let l=document.createElement("input");l.type="checkbox",l.name=s[u],l.checked=r,e.appendChild(l),n.push(l);let o=document.createElement("div");o.innerHTML=a?i[s[u]]:s[u],e.appendChild(o),t.appendChild(e)}}var translations,descriptorsBoxes=[],sourceBoxes=[],source2Boxes=[];export function loadTransAndSearchElements(){fetch("/pathfinder/script/translations.json").then((e=>e.ok?e.text():(alert("Failed to fetch translation content."),null))).then((e=>{if(null==e)return;translations=JSON.parse(e);let t=["Combat","Critical","Item Creation","Metamagic","Monster","Style","Teamwork"],n={},l={};for(let r in translations.featDescriptorsTranslations)l[r]=translations.featDescriptorsTranslations[r];for(let r in t){let e=t[r];n[e]=l[e],delete l[e]}addBoxes(n,document.getElementById("descriptors"),descriptorsBoxes,!1,!0,!0,l),addBoxes(["CRB","APG","ARG","ACG","UM","UC","UI","OA"],document.getElementById("source"),sourceBoxes,!0,!0,!1),addBoxes(["Bst","UCa","MA","MC","Uch","HA","VC","AG","BotD","UW","PA","AP","PCS","PPC","Mod","other"],document.getElementById("source2"),source2Boxes,!0,!0,!1)})).catch((e=>{console.log(e)}))}export function loadTransAndUrlFeat(){fetch("/pathfinder/script/translations.json").then((e=>e.ok?e.text():(alert("Failed to fetch translation content."),null))).then((e=>{null!=e&&(translations=JSON.parse(e),loadUrlFeat())})).catch((e=>{console.log(e)}))}function cell(e){let t=document.createElement("td");return t.innerHTML=e??"",t}function centerCell(e){let t=document.createElement("td");return t.innerHTML=e??"",t.style.textAlign="center",t}function objectCell(e){let t=document.createElement("td");return t.appendChild(e),t}function restrict(e,t){return null==e?null:e.length<t+3?e:e.substring(0,t)+"..."}function sourceLegal(e){let t=e.source,n=!1;for(let l in sourceBoxes)if(sourceBoxes[l].checked)for(let e in t){let r=translations.sourceTranslations[t[e].split(" pg.")[0]];if(n|=sourceBoxes[l].name==r.split("-")[0],n)break}for(let l in source2Boxes)if(source2Boxes[l].checked)for(let e in t){let r=translations.sourceTranslations[t[e].split(" pg.")[0]];if(n|=source2Boxes[l].name==r.split("-")[0],n)break}return n}function featLegal(e){let t=document.getElementById("name").value,n=null!=e.name_zh&&e.name_zh.includes(t)||null!=e.name&&e.name.toLowerCase().includes(t.toLowerCase()),l=e.descriptors;null==l&&(l=["none"]);let r=!1;for(let o in descriptorsBoxes){for(let e in l)if(r|=descriptorsBoxes[o].checked&&(descriptorsBoxes[o].name==l[e]||"all"==descriptorsBoxes[o].name),r)break;if(r)break}let a=sourceLegal(e),i=!document.getElementById("en").checked||null==e.name_zh;return""!=t&&n||""==t&&r&&a&&i}function populateFeat(e,t,n,l){let r=document.createElement("tr"),a=(document.createElement("div"),document.createElement("a"));a.href="/pathfinder/feat?feat="+e.key,a.target="_blank",a.innerHTML=n+(e.name_zh??e.name),l&&(a.style.color="gray");let i=objectCell(a);i.className="tooltip",r.appendChild(i),r.appendChild(centerCell(connect(e.descriptors,", ",translations.featDescriptorsTranslations))),r.appendChild(centerCell(getSimpTranslatedSource(e))),t.appendChild(r);let o=document.createElement("span");o.className="tooltiptext",o.innerHTML="loading...",i.appendChild(o),i.onmouseenter=()=>{document.body.clientWidth<600||(o.style.visibility="visible",o.style.top="10px","loading..."==o.innerHTML&&fetch("/pathfinder/feats/"+e.key+".json").then((e=>(e.ok||alert("Failed to fetch feat content."),e.text()))).then((t=>{e=JSON.parse(t),o.innerHTML="",loadFeat(e,o)})).catch((e=>{throw alert("Error: "+e.message),e})))},i.onmouseleave=()=>{o.style.visibility="hidden"}}function populateTree(e,t,n){for(let l in t){let r=t[l];if(r.marked){let t=featDict[r.key];(sourceLegal(t)||r.force)&&populateFeat(t,e,n,!featLegal(t)),populateTree(e,r.children,n+"&#12288;")}}}export function search(){let e=document.getElementById("table");e.innerHTML="";let t=document.createElement("table");t.style.border="",t.style.whiteSpace="nowrap";let n=document.createElement("tr");if(n.style.textAlign="center",n.innerHTML="<th>\u4e13\u957f</th><th>\u63cf\u8ff0\u7b26</th><th>\u51fa\u5904</th>",t.appendChild(n),document.getElementById("showTree").checked){let e=JSON.parse(JSON.stringify(featTree));for(let t in featDict){featLegal(featDict[t])&&markTree(t,e,!1)}populateTree(t,e,"")}else for(let l in featDict){let e=featDict[l];featLegal(e)&&populateFeat(e,t,"",!1)}e.appendChild(t)}document.onkeyup=e=>{"Enter"==e.key&&search()};