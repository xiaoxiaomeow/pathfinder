import $ from"jquery";import{spellsIndex}from"@site/static/script/spellsIndex";import{getUrlAttributes}from"@site/static/script/common";function connect(e,t,n){let l="";for(let s in e){let o=e[s];l+=(n[o]??o)+t}return l.substring(0,l.length-t.length)}function connectLevels(e,t){let n="";for(let l in e)n+=(t[l]??l)+" "+e[l]+", ";return n.substring(0,n.length-2)}function getTranslatedSource(e){let t="";for(let n in e.source){let l=e.source[n].split(" pg.")[0];t+=(translations.sourceTranslations[l]??l)+", "}return t.substring(0,t.length-2)}function getSimpTranslatedSource(e){if(1==e.source.length)return getTranslatedSource(e);for(let t in e.source){let n=translations.sourceTranslations[e.source[t].split(" pg.")[0]];if(!n.includes("-"))return n+", ..."}for(let t in e.source){let n=translations.sourceTranslations[e.source[t].split(" pg.")[0]];if(n.includes("PCS")||n.includes("PPC"))return n+", ..."}for(let t in e.source){return translations.sourceTranslations[e.source[t].split(" pg.")[0]]+" ..."}return""}export function loadSpell(e,t,n=!1){t.innerHTML="",n&&(window.top.document.title=e.name_zh??e.name);let l,s='<a href="'+e.url+'">'+e.name+"</a>",o=null!=e.name_zh?e.name_zh+" ("+s+")":s;if(null!=e.race_zh&&(o+=" ["+e.race_zh+"]"),o+=" <sup>"+getTranslatedSource(e)+"</sup>",n){l=$("<h3>"+o+"&#12288;</h3>");let t=document.createElement("img");t.src="/pathfinder/img/copy.svg",t.onclick=()=>{if(navigator.clipboard){let n=e.name_zh??e.name_en;navigator.clipboard.writeText("["+n+"]("+location.href+")<sup>"+getTranslatedSource(e)+"</sup>"),t.src="/pathfinder/img/check.svg",setTimeout((()=>{t.src="/pathfinder/img/copy.svg"}),2e3)}},l.append($(t))}else l=$("<h3>"+o+"</h3>");$(t).append(l);let r="<b>\u5b66\u6d3e</b>&#12288;&#12288;&#12288;&#12288;"+translations.schoolTranslations[e.school]??e.school;if(null!=e.subSchools){let t=","==e.subSchoolsOperator?", ":" \u6216 ";r+=" ("+connect(e.subSchools,t,translations.subSchoolsTranslations)+")"}if(null!=e.descriptors){let t=","==e.descriptorsOperator?", ":" \u6216 ";r+=" ["+connect(e.descriptors,t,translations.descriptorsTranslations)+"]"}$(t).append($("<div>"+r+"</div>")),null!=e.levels&&$(t).append($("<div><b>\u73af\u4f4d</b>&#12288;&#12288;&#12288;&#12288;"+connectLevels(e.levels,translations.classTranslations)+"</div>")),null!=e.castingTime_zh&&$(t).append($("<div><b>\u65bd\u6cd5\u65f6\u95f4</b>&#12288;&#12288;"+e.castingTime_zh+"</div>")),null!=e.components_zh?$(t).append($("<div><b>\u6210\u5206</b>&#12288;&#12288;&#12288;&#12288;"+e.components_zh+"</div>")):null!=e.components&&$(t).append($("<div><b>\u6210\u5206</b>&#12288;&#12288;&#12288;&#12288;"+e.components+"</div>")),null!=e.range_zh&&$(t).append($("<div><b>\u8303\u56f4</b>&#12288;&#12288;&#12288;&#12288;"+e.range_zh+"</div>")),null!=e.effect_zh?$(t).append($("<div><b>\u6548\u679c</b>&#12288;&#12288;&#12288;&#12288;"+e.effect_zh+"</div>")):null!=e.effect&&$(t).append($("<div><b>\u6548\u679c</b>&#12288;&#12288;&#12288;&#12288;"+e.effect+"</div>")),null!=e.targetOrArea_zh&&$(t).append($("<div><b>\u76ee\u6807\u6216\u8303\u56f4</b>&#12288;"+e.targetOrArea_zh+"</div>")),null!=e.target_zh&&$(t).append($("<div><b>\u76ee\u6807</b>&#12288;&#12288;&#12288;&#12288;"+e.target_zh+"</div>")),null!=e.area_zh&&$(t).append($("<div><b>\u533a\u57df</b>&#12288;&#12288;&#12288;&#12288;"+e.area_zh+"</div>")),null!=e.duration_zh&&$(t).append($("<div><b>\u6301\u7eed\u65f6\u95f4</b>&#12288;&#12288;"+e.duration_zh+"</div>")),null!=e.savingThrow_zh&&$(t).append($("<div><b>\u8c41\u514d</b>&#12288;&#12288;&#12288;&#12288;"+e.savingThrow_zh+"</div>")),null!=e.spellResistance_zh&&$(t).append($("<div><b>\u6cd5\u672f\u6297\u529b</b>&#12288;&#12288;"+e.spellResistance_zh+"</div>")),$(t).append("<p>"),null!=e.text_zh?$(t).append($(e.text_zh)):$(t).append($("<p>"+e.text+"</p>"));let a="";for(let i in e.source)a+="<br>"+e.source[i];$(t).append($("<p><b>\u51fa\u5904</b>"+a+"</p>")),(e.mythicText_zh??null!=e.mythicText)&&($(t).append($("<hr><h4>\u795e\u8bdd\u7248\u672c</h4>")),null!=e.mythicText_zh?$(t).append($(e.mythicText_zh)):$(t).append($("<p>"+e.mythicText+"</p>")),$(t).append($("<p><b>\u51fa\u5904</b><br>"+e.mythicSource+"</p>")))}function loadUrlSpell(){let e=getUrlAttributes().spell;e=e.toLowerCase(),fetch("/pathfinder/spells/"+e+".json").then((e=>e.ok?e.text():null)).then((e=>{if(null!=e){loadSpell(JSON.parse(e),document.getElementById("box"),!0)}})).catch((e=>{console.log(e)}))}function getLevels(e){let t={high:9,medium:9,low:9},n={high:-1,medium:-1,low:-1};for(let r in e.levels){let l=translations.classSpellProgression[r]??"high",s=e.levels[r];t[l]>s&&(t[l]=s),n[l]<s&&(n[l]=s)}let l={};for(let r in n)-1!=n[r]&&(n[r]==t[r]?l[r]=n[r]+"":l[r]=t[r]+"~"+n[r]);let s,o="";return null!=l.high&&(s=l.high,o+=l.high+" "),null!=l.medium&&l.medium!=s&&(s=l.medium,o+="<font color='Blue'>"+l.medium+"</font> "),null!=l.low&&l.low!=s&&(o+="<font color='Green'>"+l.low+"</font> "),o.substring(0,o.length-1)}function addBoxes(e,t,n,l=!1,s=!0,o=!0,r=!1){if(t.loaded)return;let a=document.createElement("div");a.style="display: flex; ";let i=document.createElement("input");i.type="checkbox",i.name="all",i.checked=s,a.appendChild(i),n.push(i);let c,d=document.createElement("div");if(d.innerHTML="\u5168\u9009",a.appendChild(d),t.appendChild(a),i.addEventListener("change",(e=>{for(let t in n)n[t].checked=e.currentTarget.checked})),!l){let e=document.createElement("div");e.style="display: flex; ";let l=document.createElement("input");l.type="checkbox",l.name="none",l.checked=s,e.appendChild(l),n.push(l);let o=document.createElement("div");o.innerHTML="\u65e0",e.appendChild(o),t.appendChild(e)}o?(c=Object.keys(e),c.sort()):c=e;for(let h in c){if(c[h].includes("see ")||"variable"==c[h])continue;let l=document.createElement("div");l.style="display: flex; ";let r=document.createElement("input");r.type="checkbox",r.name=c[h],r.checked=s,l.appendChild(r),n.push(r);let a=document.createElement("div");a.innerHTML=o?e[c[h]]:c[h],l.appendChild(a),t.appendChild(l)}if(r){let l=document.createElement("div");l.style="display: flex; ";let o=document.createElement("input");o.type="checkbox",o.name="other",o.checked=s,o.exclude=e,l.appendChild(o),n.push(o);let r=document.createElement("div");r.innerHTML="\u5176\u5b83",l.appendChild(r),t.appendChild(l)}t.loaded=!0}var translations,schoolBoxes=[],subSchoolsBoxes=[],descriptorsBoxes=[],classBoxes=[],levelsBoxes=[],sourceBoxes=[],source2Boxes=[],castingTimeBoxes=[],durationBoxes=[],spellResistanceBoxes=[],rangeBoxes=[],savingThrowBoxes=[];export function loadTransAndSearchElements(){fetch("/pathfinder/script/translations.json").then((e=>e.ok?e.text():(alert("Failed to fetch translation content."),null))).then((e=>{if(null==e)return;addBoxes((translations=JSON.parse(e)).schoolTranslations,document.getElementById("school"),schoolBoxes,!0),addBoxes(translations.subSchoolsTranslations,document.getElementById("subSchools"),subSchoolsBoxes),addBoxes(translations.descriptorsTranslations,document.getElementById("descriptors"),descriptorsBoxes),addBoxes(translations.classTranslations,document.getElementById("clazz"),classBoxes,!0,!1);let t={};for(let n=0;n<=9;n++)t[n]=n+"\u73af";addBoxes(t,document.getElementById("levels"),levelsBoxes,!0,!1),addBoxes(["CRB","APG","ARG","ACG","UM","UC","UI","OA"],document.getElementById("source"),sourceBoxes,!0,!0,!1),addBoxes(["MA","MC","HA","VC","AG","BotD","UW","PA","AP","PCS","PPC","Mod","other"],document.getElementById("source2"),source2Boxes,!0,!0,!1),addBoxes(["\u6807\u51c6\u52a8\u4f5c","\u8fc5\u6377\u52a8\u4f5c","\u76f4\u89c9\u52a8\u4f5c","\u6574\u8f6e\u52a8\u4f5c","1\u8f6e","1\u5206\u949f","10\u5206\u949f","1\u5c0f\u65f6"],document.getElementById("castingTime"),castingTimeBoxes,!0,!0,!1,!0),addBoxes(["\u7acb\u5373","1\u8f6e","1\u8f6e/\u7b49\u7ea7","1\u5206\u949f/\u7b49\u7ea7","10\u5206\u949f/\u7b49\u7ea7","1\u5c0f\u65f6/\u7b49\u7ea7","24\u5c0f\u65f6","1\u5929/\u7b49\u7ea7","\u6c38\u4e45"],document.getElementById("duration"),durationBoxes,!0,!0,!1,!0),addBoxes(["\u4e2a\u4eba","\u63a5\u89e6","\u8fd1\u8ddd","\u4e2d\u8ddd","\u8fdc\u8ddd"],document.getElementById("range"),rangeBoxes,!0,!0,!1,!0),addBoxes(["\u5426","\u53ef"],document.getElementById("spellResistance"),spellResistanceBoxes,!0,!0,!1,!0),addBoxes(["\u53cd\u5c04","\u5f3a\u97e7","\u610f\u5fd7","\u65e0"],document.getElementById("savingThrow"),savingThrowBoxes,!0,!0,!1,!0)})).catch((e=>{console.log(e)}))}export function loadTransAndUrlSpell(){fetch("/pathfinder/script/translations.json").then((e=>e.ok?e.text():(alert("Failed to fetch translation content."),null))).then((e=>{null!=e&&(translations=JSON.parse(e),loadUrlSpell())})).catch((e=>{console.log(e)}))}function cell(e){let t=document.createElement("td");return t.innerHTML=e??"",t}function centerCell(e){let t=document.createElement("td");return t.innerHTML=e??"",t.style.textAlign="center",t}function objectCell(e){let t=document.createElement("td");return t.appendChild(e),t}function restrict(e,t){return null==e?null:e.length<t+3?e:e.substring(0,t)+"..."}export function search(){let e=document.getElementById("table");e.innerHTML="";let t=document.createElement("table");t.style.border="",t.style.whiteSpace="nowrap";let n=document.createElement("tr");n.style.textAlign="center",n.innerHTML="<th>\u6cd5\u672f</th><th>\u5b66\u6d3e</th><th>\u5b50\u5b66\u6d3e</th><th>\u63cf\u8ff0\u7b26</th><th>\u51fa\u5904</th><th>\u73af\u4f4d</th><th>\u79cd\u65cf/\u795e\u7947</th><th>\u65bd\u6cd5\u65f6\u95f4</th><th>\u6301\u7eed\u65f6\u95f4</th><th>\u8303\u56f4</th><th>\u6cd5\u672f\u6297\u529b</th><th>\u8c41\u514d</th>",t.appendChild(n);for(let l in spellsIndex){let e=spellsIndex[l],n=document.getElementById("name").value,s=null!=e.name_zh&&e.name_zh.includes(n)||null!=e.name&&e.name.toLowerCase().includes(n.toLowerCase()),o=e.school,r=!1;for(let t in schoolBoxes)if(r|=schoolBoxes[t].checked&&schoolBoxes[t].name==o,r)break;let a=e.subSchools;null==a&&(a=["none"]);let i=!1;for(let t in subSchoolsBoxes){for(let e in a)if(i|=subSchoolsBoxes[t].checked&&subSchoolsBoxes[t].name==a[e],i)break;if(i)break}let c=e.descriptors;null==c&&(c=["none"]);let d=!1;for(let t in descriptorsBoxes){for(let e in c)if(d|=descriptorsBoxes[t].checked&&(descriptorsBoxes[t].name==c[e]||"all"==descriptorsBoxes[t].name),d)break;if(d)break}let h=e.levels,p=!1;if(null!=h)for(let t in h){let e=!1,n=!1;for(let l in classBoxes)e|=classBoxes[l].checked&&t==classBoxes[l].name;for(let l in levelsBoxes)n|=levelsBoxes[l].checked&&levelsBoxes[l].name==h[t];if(p|=e&&n,p)break}let u=e.source,m=!1;for(let t in sourceBoxes)if(sourceBoxes[t].checked)for(let e in u){let n=translations.sourceTranslations[u[e].split(" pg.")[0]];if(m|=sourceBoxes[t].name==n.split("-")[0],m)break}for(let t in source2Boxes)if(source2Boxes[t].checked)for(let e in u){let n=translations.sourceTranslations[u[e].split(" pg.")[0]];if(m|=source2Boxes[t].name==n.split("-")[0],m)break}let x=!1;{let t=e.castingTime_zh,n=!0;for(let e in castingTimeBoxes)if("other"==castingTimeBoxes[e].name?x|=castingTimeBoxes[e].checked&&n:null!=t&&t.includes(castingTimeBoxes[e].name)&&(n=!1,x|=castingTimeBoxes[e].checked),x)break}let f=!1;{let t=e.duration_zh,n=!0;for(let e in durationBoxes)if("other"==durationBoxes[e].name?f|=durationBoxes[e].checked&&n:null!=t&&t.includes(durationBoxes[e].name)&&("1\u8f6e"==durationBoxes[e].name&&"1\u8f6e"!=t||(n=!1,f|=durationBoxes[e].checked)),f)break}let g=!1;{let t=e.range_zh,n=!0;for(let e in rangeBoxes)if("other"==rangeBoxes[e].name?g|=rangeBoxes[e].checked&&n:null!=t&&t.includes(rangeBoxes[e].name)&&(n=!1,g|=rangeBoxes[e].checked),g)break}let B=!1;{let t=e.spellResistance_zh,n=!0;for(let e in spellResistanceBoxes)if("other"==spellResistanceBoxes[e].name?B|=spellResistanceBoxes[e].checked&&n:null!=t&&t.includes(spellResistanceBoxes[e].name)&&(n=!1,B|=spellResistanceBoxes[e].checked),B)break}let b=!1;{let t=e.savingThrow_zh,n=!0;for(let e in savingThrowBoxes)if("other"==savingThrowBoxes[e].name?b|=savingThrowBoxes[e].checked&&n:null!=t&&t.includes(savingThrowBoxes[e].name)&&(n=!1,b|=savingThrowBoxes[e].checked),b)break}let v=!document.getElementById("race").checked||null!=e.race,T=!document.getElementById("mythic").checked||e.mythic,C=!document.getElementById("en").checked||null==e.name_zh;if(""!=n&&s||""==n&&r&&i&&d&&p&&m&&x&&f&&g&&B&&b&&v&&T&&C){let n=document.createElement("tr"),l=document.createElement("a");l.href="/pathfinder/spell?spell="+e.key,l.target="_blank",l.innerHTML=e.name_zh??e.name;let s=objectCell(l);s.className="tooltip",n.appendChild(s),n.appendChild(centerCell(translations.schoolTranslations[e.school]??e.school));let o=null;if(null!=e.subSchools){let t=","==e.subSchoolsOperator?", ":" \u6216 ";o=connect(e.subSchools,t,translations.subSchoolsTranslations)}n.appendChild(centerCell(o));let r=null;if(null!=e.descriptors){let t=","==e.descriptorsOperator?", ":" \u6216 ";r=connect(e.descriptors,t,translations.descriptorsTranslations)}n.appendChild(centerCell(restrict(r,15))),n.appendChild(centerCell(getSimpTranslatedSource(e))),n.appendChild(centerCell(getLevels(e)));let a=translations.raceTranslations[e.race];null!=a&&""!=a||(a=e.race),n.appendChild(centerCell(restrict(a,10))),n.appendChild(centerCell(restrict(e.castingTime_zh,4))),n.appendChild(centerCell(restrict(e.duration_zh,6))),n.appendChild(centerCell(restrict(e.range_zh,4))),n.appendChild(centerCell(restrict(e.spellResistance_zh,6))),n.appendChild(centerCell(restrict(e.savingThrow_zh,11))),t.appendChild(n);let i=document.createElement("span");i.className="tooltiptext",i.innerHTML="loading...",s.appendChild(i),s.onmouseenter=()=>{document.body.clientWidth<600||(i.style.visibility="visible",i.style.top="10px","loading..."==i.innerHTML&&fetch("/pathfinder/spells/"+e.key+".json").then((e=>(e.ok||alert("Failed to fetch spell content."),e.text()))).then((t=>{e=JSON.parse(t),i.innerHTML="",loadSpell(e,i)})).catch((e=>{throw alert("Error: "+e.message),e})))},s.onmouseleave=()=>{i.style.visibility="hidden"}}}e.appendChild(t)}